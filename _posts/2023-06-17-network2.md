---
title: "네트워크 4-2 네트워크 계층: NAT와 DHCP"

categories:
  - Network
tags:
  - Network
---

> 이 글은 KOCW에서 제공하는 한양대학교 이석복 교수님의 컴퓨터 네트워크 강의를 기반으로 내용을 정리하고 복습하기 위한 용도로 작성되었습니다.

## NAT(Network Address Translation)

> ip주소는 32비트로 약 40억개의 주소를 가질 수 있다. 그렇다면 현재 인터넷 상에는 이미 40억개가 넘는 ip주소가 생성되었어야 할텐데 어떻게 32비트의 ip주소를 계속 사용중일까? 거기엔 **NAT**라는 트릭이 사용된다.

#### 1. NAT란?

---

- 같은 네트워크(서브넷) 안에서는 호스트들이 각자 다른 ip주소를 사용할지언정 외부 네트워크로 데이터가 전송될때는 NAT의 기능을 하는 게이트웨이 라우터를 거쳐간다.
- 이때 게이트웨이에서 데이터를 전송할때 ip주소를 네트워크가 관장하는 고유한 ip주소로 변조한다.
- 반대로 외부에서 데이터가 들어올때도 게이트웨이가 ip주소를 다시 작성해준다.
- 좀 더 구체적으로 알아보자.

![5-6](https://github.com/mjh851819/mjh851819.github.io/assets/70308520/a527def7-c8ab-43f9-9f1c-eb423fc2f8fa)

- 오른쪽 네트워크에 속하는 호스트들의 ip주소들은 네트워크 내부에선 유일하다.
- 오른쪽 머신의 프로세스에서 데이터를 보내면 NAT라우터가 ip주소와 포트번호까지 다시 작성해서 외부 네트워크로 전송한다.
- 이때 바뀐 ip주소와 포트번호를 NAT 내부 테이블에 저장해놓는다. 그리고 응답에 대한 데이터가 들어오면 해당 네트워크까지는 ip주소로 찾아가고, 어떤 호스트로 데이터가 갈지는 바뀐 포트번호를 통해서 올바르게 데이터를 전달한다.
  **하지만 NAT는 치명적인 문제점들이 존재한다.**

#### 2. NAT의 문제점 1: 포트번호의 변조

---

- 가장 직관적인 문제는 포트번호의 변조에 있다.
- _결론부터 말하면 NAT를 사용하는 네트워크 안에있는 호스트는 서버를 운영할 수 없다._
- 그 이유는 포트번호를 네트워크 내의 호스트를 찾는 번지수로 사용하기 때문이다.
- 내가 NAT를 사용하는 네트워크 안에서 1번 포트를 열어서 서버를 열고싶다고 가정하자.
- 외부 프로세스에서 목적지를 1번포트로 설정하고 데이터를 보낸다면?
- 해당 데이터는 나의 서버까지 도달할 수 없다. NAT 라우터에서 해당 데이터의 1번포트가 네트워크 내부의 호스트를 찾는 다른 포트번호로 변조되기 때문이다.
- 따라서 NAT 네트워크 내부의 호스트들은 클라이언트의 역할밖에 할 수 없다.
  > 그렇다면 NAT의 뒤에서 서버를 운영하려면 어떻게 해야할까?
- 첫번째 방법은 NAT의 테이블에 미리 포트번호와 ip주소를 맵핑해놔서 외부로부터 - - 요청이 왔을때 나의 호스트와 포트번호로 요청이 도달할 수있게 조작해놓는것이다. -하지만 현실에서 SKT의 NAT테이블에 자신의 ip주소와 포트번호를 맵핑해달라고 요청하는것이 가능할까? SKT가 아닌 소규모 네트워크가 아니라면 굉장히 높은확률로 불가능하다.

#### 2. NAT의 문제점 2: Layer 침범

---

- 또다른 문제는 NAT라우터에 있다.
- 위에 설명한 과정을 살펴보면 NAT라우터는 호스트가 전달할 데이터의 ip주소와 포트번호를 수정한다.
- 이때 라우터의 네트워크 계층에서 다루는 데이터의 단위는 패킷이기에 패킷의 헤더에 있는 ip주소의 변경은 그럴수 있다 치자.
- 하지만 포트번호는 패킷의 헤더가 아닌 데이터 영역에서의 변경이 일어난다.
- 이는 레이어의 기능과 권한을 침범하는 행위며 보안 등의 다른 문제를 야기할 수 있다.

> 현대의 네트워크는 NAT방식에 굉장히 발을 깊게 담궈서 더이상 NAT가 없으면 네트워크를 유지할 수 없는 수준까지 와버렸고 많은 네트워크 개발자들이
> 우려를 표하고 있다.

## DHCP (Dynamic Host Configuration Protocol)

#### 1. DHCP란 무엇일까?

---

- ip주소가 있다는것은 자신이 한 네트워크 안의 호스트로서 속하는것을 의미한다.
- _그렇다면 이러한 ip주소는 언제 어떻게 부여될까?_
- 한양대학교 네트워크에 배정되는 상황을 가정해보자.
- 신입생이 네트워크를 사용할 수 있도록 고정적인 ip번호를 졸업할때까지 사용하도록 부여받는 방식이 과연 옳을까?
- 이런식이라면 네트워크를 사용하지 않는동안 해당 네트워크가 낭비되는 문제점이 있다.
- 따라서 *일정 ip주소를 관리하는 풀*을 두고 네트워크를 사용하는 학생들에게만 ip주소를 부여하는 방식을 사용하는것이 옳을것이다.
- 이러한 방식을 사용하면 누구든지 네트워크를 지원하는 공간에 들어오면 해당 네트워크를 사용할 수 있고, 이로 인해 네트워크가 사용자의 위치와 밀접한 관계를 맺을 수 있게 해준다.

#### 2. -DHCP(Dynamic Host Configuration Protocol)의 정의

---

- 의미 그대로 동적으로 호스트를 설정해주는 프로토콜 이라는 의미다.

![5-7](https://github.com/mjh851819/mjh851819.github.io/assets/70308520/bc858985-8b80-444e-869f-d0475ddc065e)

- DHCP의 과정을 처음부터 살펴보자.

- 1.**내가 이디아 커피에가서 노트북을 펴고 네트워크를 사용하고싶다.**

> - 하지만 초기 상태에선 인터넷 연결도 ip주소도 아무것도 없다.

- 2.**이때 우리는 이디아의 네트워크에 도움을 요청해야하는데 이러한 요청을 _DHCP discover_ 메세지 라고 한다.**

> - 클라이언트는 DHCP discover를 0.0.0.0:68 의 source ip:포트로, 255.255.255.255:67 의 dest 로 요청을 보낸다.
> - 이 요청의 의미를 더욱 자세히 알아보면 클라이언트는 초기 ip주소가 없기에 0.0.0.0의 ip주소의 상태로 255.255.255.255로 요청을 보내는 것이다.
> - 255.255.255.255는 서브넷 마스크로 해당 ip로 요청을 보내면 이디아의 서브넷 내부 모든 호스트들에게 요청이 간다.
> - 이러한 요청은 서브넷 내부의 DHCP 서버에게 도달해야하는데 약속된 포트번호인 67번의 포트번호로 보내면 다른 호스트들은 해당 요청을 무시하고(포트번호를 설정해놓지 않으므로) DHCP 서버만이 해당 요청을 받을 수 있다.

- 3.**이러한 요청에 DHCP 서버는 yiaddrr값에 사용할 수 있는 ip주소를 클라이언트에게 전송하는데 이러한 응답을 DHCP offer라고 한다.**

> - DHCP offer 또한 목적지는 255.255...인데 이때는 transactionID를 같이 응답에 보냄으로써 클라이언트가 이를 확인할 수 있다.

- 4.**해당 ip주소를 확인한 클라이언트는 다시금 해당 ip를 사용하겠다고 DHCP request를 서버에 보내고 DHCP 서버가 ACKs로 응답하면서 ip주소의 부여가 완료된다.**

> - 이때 DHCP서버는 클라이언트에게 중요한 3가지 정보를 전달한다.

> 1. IP Addr / subnet mask
> 2. GWR IP Addr
> 3. Local Name Server IP Addr
>    보통 DHCP는 게이트웨이 라우터에서 동작하며 NAT와 Local Name server도 게이트웨이 라우터의 역할이다.

- DHCP는 왜 4번의 데이터를 주고받을까? 2번이면 충분할거 같은데...
  > 현실에서는 discover 메세지를 보냈을때 offer를 주는 서브넷이 많기때문에 어떤 offer를 골랐는지 확답을 주기위해서 4번의 데이터를 주고받는다.
- DHCP request 시점에서 클라이언트는 이미 사용할 서브넷 DHCP서버의 주소를 알고있는데 왜 서브넷 마스크로 request를 보낼까?
  > 다른 서브넷에게 자신이 사용할 ip주소를 알려주기 위해서이다. 또한 DHCP 서버에게 ACKs를 받은 이후부터 클라이언트에게 ip주소가 부여된다 그전까진(0.0.0.0)
